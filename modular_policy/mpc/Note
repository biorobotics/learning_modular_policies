Modified slightly from https://locuslab.github.io/mpc.pytorch/